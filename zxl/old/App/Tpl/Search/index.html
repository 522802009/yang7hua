<include file="Public:header" />


 <form class="bs-example bs-example-form" action="/search" method="POST" name="search">
    <div class="row hao_row">
    <div class="col-lg-4"></div>
      <div class="col-lg-4">
        <div class="input-group">
          <input type="text" class="form-control" name="keyword" placeholder="请输入身份证号码">
          <span class="input-group-btn">
          <button class="btn btn-primary" type="submit" id="search-submit">查询</button>
          </span> </div>
      </div>
      <div class="col-lg-4"></div>
    </div>
 </form>
 
 <div id="result" class="hide">
	  <div class="row hao_tab">
	  	<div class="col-lg-6">身份证号码：<span id="idcard"></span></div> 	
	  </div>
	  <div class="row hao_tab">
		  <!-- Nav tabs -->
			<ul class="nav nav-tabs">
			  <li class="active"><a href="#finished" data-toggle="tab">成功借款 <span class="badge" id="finished_count">0</span></a></li>
			  <li><a href="#unfinished" data-toggle="tab">未完成借款 <span class="badge" id="unfinished_count">0</span></a></li>
			  <li class="hide"><a href="#record" data-toggle="tab">查询记录 <span class="badge" id="record_count">0</span></a></li>
			</ul>
	
			<!-- Tab panes -->
		<div class="tab-content">
			<include file="loanlist_js"/>
			<include file="Public:page_js"/>
			  <div class="tab-pane fade in active" id="finished">
			  		<div class="panel">
						 <div class="panel-body">
							  <div class="loanlist"></div>
							  <div class="pagination"></div>
						</div>
					</div>
			  </div>
			  <div class="tab-pane fade" id="unfinished">
				  	<div class="panel">					 
					 	<div class="panel-body">
					 		<div class="loanlist"></div>
							<div class="pagination"></div>
						</div>					
					</div>
			  </div>
			  <div class="tab-pane fade" id="rechord">
				  <div class="panel">					 
					 	<div class="panel-body">
							<div class="recordlist"></div>
							<div class="pagination"></div>
						</div>
					</div>
			  </div>
		</div>
	</div>
</div>

<script type="text/javascript" src="__static/js/jquery.template.min.js"></script>
<script type="text/javascript">
	var idcard,
		limit = 2,
		finished,unfinished,record;

	function reset(){
		finished = unfinished = record = false;//重置查询状态
		$('.loanlist, .recordlist, .pagination').html('');
		$('.nav-tabs li').eq(0).addClass('active').siblings().removeClass('active');
		$('.tab-pane').eq(0).addClass('active in').siblings().removeClass('active in');
	}
	$(function(){
		$('#search-submit').click(function(){
			var form = $('[name=search]');
				keyword = $('[name=keyword]');
			
			idcard = keyword.val();
			reset();
			$.ajax({
				url : '/search',
				type : 'post',
				dataType : 'json',
				data : {
					idcard : idcard,
					limit : limit
				},
				success : function(res){
					if(res['return']>0){
						$('#result').removeClass('hide');
						$('#idcard').text(idcard);
						
						$('#finished_count').text(res['data']['finished']['count']);
						$('#unfinished_count').text(res['data']['unfinished']['count']);
						$('#record_count').text(res['data']['record']['count']);
						
						var finished_list = $.template('loanlist_js', res['data']['finished']),
							finished_page = $.template('pagelist_js', res['data']['finished']);
						$('#finished .loanlist').html(finished_list);
						$('#finished .pagination').html(finished_page);

						finished = true;
					}else{						
						$('#result').addClass('hide');
						alert(res['errmsg']);
					}
				}
			})
			return false;
		})
		
		var type = 'finished';				
		
		function loadList(opts){
			var data = {
				limit : limit,
				idcard : idcard,
				type : type == 'finished' ? 1 : (type == 'unfinished' ? 2 : 3)
			};			
			if(typeof opts == 'object')
				$.extend(data, opts);
			
			$.ajax({
				url : '/search',
				type : 'post',
				dataType : 'json',
				data : data,
				success : function(res){
					if(res['return'] > 0){
						var html = $.template('loanlist_js', res['data']),
							pagehtml = $.template('pagelist_js', res['data']);
						$('#'+type).find('.loanlist').html(html);
						$('#'+type).find('.pagination').html(pagehtml);
						if(type == 'finished')
							finished = true;
						else if(type == 'unfinished')
							unfinished = true;
						else if(type == 'record')
							record = true;
					}else{
						$('#result').addClass('hide');
						alert(res['errmsg']);
					}
				}
			})
		}	
		
		$('.nav-tabs li').click(function(){
			type = $(this).find('a').attr('href').replace('#','');
			if(!eval(type))
				loadList();
		});
		
		var p = page();		
		p.click(function(n){
			loadList({
				p : n
			})
		})
	})

</script>

<include file="Public:footer" />
