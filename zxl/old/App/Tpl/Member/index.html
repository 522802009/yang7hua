<include file="Public:header"/>

<nav class="navbar navbar-default hao_tab hao_navbar" role="navigation">
<span>{$info['companyname']}</span>
<a href="/member/edit" class="btn btn-default navbar-btn">修改公司资料</a>
<a href="/member/users" class="btn btn-default navbar-btn">借款人管理</a>
<a href="/member" class="btn btn-default navbar-btn">借款管理</a>
</nav>  
  <div class="row hao_tab">

<ul class="nav nav-tabs">
  <li class="active"><a href="#finished" data-toggle="tab">成功借款 <span class="badge">{$finished_count}</span></a></li>
  <li><a href="#unfinished" data-toggle="tab">未完成借款 <span class="badge">{$unfinished_count}</span></a></li>
</ul>


<div class="tab-content">
	  <div class="tab-pane active fade in" id="finished">
	  	
	  	<div class="panel-body">
		  <!-- Table -->
		  <div class="loanlist"></div>
		  <div class="pagination"></div>	  
		</div>
	  </div><!--/. home -->
  	  
  	  <include file="Loan/loanlist_js" />
	  <include file="Public:page_js" />
	  
	  <div class="tab-pane fade" id="unfinished">
	  	<div class="panel-body">
		  <!-- Table -->
		  <div class="loanlist"></div>
		  <div class="pagination"></div>
		</div>
	  </div>
</div>
  </div>

<script type="text/javascript" src="__static/js/jquery.template.min.js"></script>
<script type="text/javascript">	
	$(function(){
		
		var type = 'finished',
			finished = unfinished = false;
		
		function loadList(opts){
			var data = {
					type : type=='finished' ? 1 : 2,
					limit : 2
			};
			if(type == 'finished')
				finished = true;
			if(type == 'unfinished')
				unfinished = true;
			if(typeof opts == 'object')
				$.extend(data, opts);
			$.ajax({
				url : '/loan/data',
				type : 'post',
				dataType : 'json',
				data : data,
				success : function(res){
					if(res['return'] > 0){
						var obj = $('#'+type),
							html = $.template('loanlist_js', res['data']),
							page = $.template('pagelist_js', res['data']);
						obj.find('.loanlist').html(html);
						obj.find('.pagination').html(page);
					}
				}
			});	
		}	
		
		loadList();	
		
		$('.nav-tabs li').click(function(){
			type = $(this).find('a').attr('href').replace('#','');
			if(!eval(type))
				loadList();
		})
		
		
		var p = page();		
		p.click(function(n){
			loadList({
				p : n
			})
		});

		function toggle(parent, type){
			if(type == undefined)
				type = 'show';
			if(type == 'hide'){
				parent.find('[name=status], .save').addClass('hidden');
				parent.find('.input-text, .edit').removeClass('hidden');
			}else if(type == 'show'){
				parent.find('[name=status], .save').removeClass('hidden');				
				parent.find('.input-text, .edit').addClass('hidden');				
			}
		}

		$(".loanlist").delegate('.edit', 'click', function(){
			var parent = $(this).closest('tr');
			toggle(parent);
			return false;
		});
		$('.loanlist').delegate('.save', 'click', function(){
			var parent = $(this).closest('tr'),
				status = parent.find('[name=status]').val(),
				statusDefault = $(this).attr('status');
			if(status == statusDefault){
				toggle(parent, 'hide');
				return false;
			}
			var lid = $(this).attr('lid');
			$.ajax({
				url : '/loan/update',
				type : 'post',
				dataType : 'json',
				data : {
					lid : lid,
					status : status
				},
				success : function(res){
					console.log(res);
					if(res['return'] > 0){
						alert(res['msg']);
						toggle(parent,'hide');
						location.reload();
					}else{
						alert(res['errmsg']);
					}
				}
			});
			return false;
		});
	})
</script>

<include file="Public:footer" />
